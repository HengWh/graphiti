def create_extraction_prompt(im_conversation_text: str) -> str:
    """
    生成一个精心设计的Prompt，用于从IM对话中提取实体。

    这个Prompt的设计目标是：
    1.  让LLM输出的JSON结构与我们的Ground Truth格式保持一致（除了id字段）。
    2.  通过详细的定义和示例，提高提取的准确率和召回率。
    """
    # Using a separate template string and .format() is safer and more readable
    # than escaping many curly braces in a large f-string.
    prompt_template = """### 指令 ###
你是一个顶级的实体提取与归一化AI。你的核心任务是：
1.  **精准提取**：从公司内部IM（即时通讯）对话中，抽取出预定义的实体。
2.  **实体归一化**：将指向同一真实实体的不同表述（例如："王强"、"王强哥"、"新人王强"）进行归一化，提取出最核心、最简洁的官方名称。
你的任务是：仔细阅读"待处理的对话记录"，并严格按照"JSON输出格式要求"返回一个JSON对象。
除了JSON对象，不要输出任何额外的解释、开场白或结束语。

### 实体定义与属性 ###
你必须从以下类型中提取实体：
1.  **Person**: 员工姓名、昵称或代称。
    - **提取规则 (重要)**: 提取时应包含原文中与姓名直接相邻的、用于描述身份的修饰词，如职位、部门、或“新人”等称谓。例如，对于“新人刘洋”，应提取“新人刘洋”；对于“产品部的张三”，应提取“产品部的张三”。
    - **排除规则**: **不要**提取以"@"开头的文本（例如"@王强"）作为独立的实体。这些通常是用于提醒（mention），而不是独立的实体指代。你应该提取不含"@"的实体（例如，从"@李明 (项目经理)"中提取"李明"）。
    - **attributes**:
        - `normalized_text`: 将提取到的员工姓名、昵称或代称归一化为最核心的官方姓名。例如，"架构组的王强"、"王强哥"、"新人王强"都应归一化为"王强"。
2.  **Project**: 项目、计划或行动的正式名称。例如: "盘古项目", "灯塔计划", "鲲鹏计划"。
3.  **Document**: 一个具体的、有明确名称的文档、文件、报告等。
    - **提取要求**: 必须提取具有明确、特定名称的文档。例如 "盘古项目技术方案_v1.2.docx" 是一个有效的文档。
    - **排除规则**: **不要**提取泛指的、没有具体名称的文档类型。例如，像 "会议纪要"、"进展材料"、"那个文档"、"分享的PPT" 这类模糊的表述，**不应**被视为独立的Document实体，除非它们有更具体的文件名。
    - **attributes**:
        - `title`: 文档的核心标题 (从文件名中去除版本和格式)。
        - `version`: 版本号，如果没有版本号，省略此字段。例如: "v3.1", "FINAL_v4.0", "W46"。
        - `format`: 文件格式。例如: "docx", "pdf", "xlsx", "pptx", "png", "md"。
        - `project`: 如果文档明确关联某个项目。
        - `meeting`: 如果文档是某个会议的产物 (如会议纪要)。
4.  **Task**: 一个需要被执行或正在讨论的具体工作，特指在公司工作台中创建的任务。
    - **提取要求**: 任务在对话中通常以 `#` 开头，后跟一串数字的任务ID和任务标题。例如: "#388270 妙豚豚-个人记忆与智能工作系统-Delphinus"。
    - **排除规则**: **不要**提取没有明确任务ID的、泛指的工作。例如 "你跟进一下这个事"、"记得更新文档" 这类模糊表述，**不应**被视为独立的Task实体。
    - **attributes**:
        - `workbench_id`: 从 `#` 号后提取的唯一任务编号 (例如: "388270")。
        - `title`: 任务的完整标题 (例如: "妙豚豚-个人记忆与智能工作系统-Delphinus")。

5.  **Meeting**: 一次会议的名称或代称。
    - **提取要求**: 即使会议没有正式名称（如"Q2战略复盘会"），如果能从上下文中明确其存在和主题（如"上周三的评审会"，"又在周四下午紧急拉了个会","那次紧急会议的会议纪要"），就应该被提取。
    - **合并规则 (重要)**: 如果对话中多次提及同一个会议事件（例如，在不同时间点讨论"周三的评审会"），你必须将它们合并为**一个**实体。最终提取的`text`应选择最能代表该会议的表述，并在`attributes`中聚合所有相关信息。

### JSON输出格式要求 ###
你必须输出一个JSON对象，该对象只包含一个名为 "entities" 的键，其值为一个列表。
列表中的每个元素都是一个实体对象，该对象必须包含以下键：
- **`text`**: 从原文中一字不差地抽取的实体文本。**重要提示**：如果原文中的实体带有引号（例如 "盘古项目"），提取时请务必去除引号。
- **`type`**: 上述定义的实体类型之一。
- **`context`**: 原文中能证明该实体身份的最直接的上下文短语。这对于理解提取原因至关重要。
- **`attributes`**: 一个包含实体属性的JSON对象。如果实体没有任何可提取的属性，请提供一个空对象 `{{}}`。

### 示例 ###
**输入:**
"李雷：@韩梅梅 咱们上周三开完评审会，结论是啥？
韩梅梅：上周三的评审会开到一半，架构组的王强过来提了个新的性能风险，所以我们临时中断，又在周四下午紧急拉了个会，专门讨论存储方案。关于评审会的结论，我发了个文档 `评审会初步结论.md` 给你。
李雷：收到。那我把 #388271 妙豚豚-存储方案调研 这个任务关联到周四的会上。
韩梅梅：好。对了，那次会议的纪要我让新人刘洋整理了，应该在他那。"

**输出:**
```json
{{
  "entities": [
    {{
      "text": "李雷",
      "type": "Person",
      "context": "李雷：@韩梅梅 咱们上周三开完评审会",
      "attributes": {{
        "normalized_text": "李雷"
      }}
    }},
    {{
      "text": "韩梅梅",
      "type": "Person",
      "context": "李雷：@韩梅梅 咱们上周三开完评审会",
      "attributes": {{
        "normalized_text": "韩梅梅"
      }}
    }},
    {{
      "text": "评审会",
      "type": "Meeting",
      "context": "上周三的评审会开到一半，架构组的王强过来提了个新的性能风险",
      "attributes": {{
        "topic": "评审",
        "time_description": "上周三"
      }}
    }},
    {{
      "text": "架构组的王强",
      "type": "Person",
      "context": "架构组的王强过来提了个新的性能风险",
      "attributes": {{
        "normalized_text": "王强"
      }}
    }},
    {{
      "text": "紧急会议",
      "type": "Meeting",
      "context": "又在周四下午紧急拉了个会，专门讨论存储方案",
      "attributes": {{
        "topic": "存储方案讨论",
        "time_description": "周四下午"
      }}
    }},
    {{
      "text": "评审会初步结论.md",
      "type": "Document",
      "context": "我发了个文档 `评审会初步结论.md` 给你",
      "attributes": {{
        "title": "评审会初步结论",
        "format": "md"
      }}
    }},
    {{
      "text": "妙豚豚-存储方案调研",
      "type": "Task",
      "context": "#388271 妙豚豚-存储方案调研 这个任务关联到周四的会上",
      "attributes": {{
        "workbench_id": "388271",
        "title": "妙豚豚-存储方案调研"
      }}
    }},
    {{
      "text": "新人刘洋",
      "type": "Person",
      "context": "那次会议的纪要我让新人刘洋整理了",
      "attributes": {{
        "normalized_text": "刘洋"
      }}
    }}
  ]
}}
```

### 待处理的对话记录 ###
{conversation}

### 你的输出 ###
"""
    return prompt_template.format(conversation=im_conversation_text)
